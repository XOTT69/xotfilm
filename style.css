/* ==========================================
   LAMPA ZERO CORE v1.0
   ========================================== */

// --- НАЛАШТУВАННЯ ---
const API_KEY = 'c3d325262a386fc19e9cb286c843c8294'; // Публічний ключ (краще заміни на свій)
const BASE_URL = 'https://api.themoviedb.org/3';
const IMG_URL = 'https://image.tmdb.org/t/p/w500';

// --- ЕМУЛЯЦІЯ LAMPA API ---
const Listener = {
    _ev: {},
    follow(n, c) { (this._ev[n] = this._ev[n] || []).push(c); },
    send(n, d) { (this._ev[n] || []).forEach(c => c(d)); }
};

const Storage = {
    get: (n, d) => localStorage.getItem(n) || d,
    set: (n, v) => localStorage.setItem(n, v)
};

const Utils = {
    putScriptAsync: (urls, cb) => {
        if(!Array.isArray(urls)) urls = [urls];
        let c = 0;
        urls.forEach(u => {
            let s = document.createElement('script');
            s.src = u;
            s.onload = () => { if(++c == urls.length && cb) cb(); };
            document.head.appendChild(s);
        });
    },
    toggleFullScreen: () => {
        if (!document.fullscreenElement) document.documentElement.requestFullscreen();
        else if (document.exitFullscreen) document.exitFullscreen();
    }
};

const Template = {
    get: (name, obj) => { /* Для плагінів - заглушка */ return ''; }
};

// Збираємо глобальний об'єкт
window.Lampa = { Listener, Storage, Utils, Template, Manifest: { app_digital: 300 } };


// --- ЛОГІКА ДОДАТКУ ---

// 1. РОБОТА З API (TMDB)
const Api = {
    async get(method, params = '') {
        try {
            let url = `${BASE_URL}/${method}?api_key=${API_KEY}&language=uk-UA${params}`;
            let res = await fetch(url);
            return await res.json();
        } catch (e) { console.error(e); return null; }
    },
    
    async loadTrending() {
        return await this.get('trending/movie/week');
    },
    
    async search(query) {
        return await this.get('search/movie', `&query=${encodeURIComponent(query)}`);
    }
};

// 2. РЕНДЕР КАРТОК
function renderCards(data, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    if (!data || !data.results || data.results.length === 0) {
        container.innerHTML = '<div style="padding:20px;color:#666">Нічого не знайдено</div>';
        return;
    }

    data.results.forEach(item => {
        if(!item.poster_path) return; // Пропускаємо без постерів
        
        let el = document.createElement('div');
        el.className = 'card';
        el.tabIndex = -1;
        // Зберігаємо дані фільму прямо в елементі
        el.dataset.title = item.title || item.name;
        el.dataset.overview = item.overview;
        el.dataset.year = (item.release_date || item.first_air_date || '').substr(0,4);
        el.dataset.rating = item.vote_average;
        el.dataset.img = IMG_URL + item.poster_path;

        el.innerHTML = `
            <div class="card-img" style="background-image: url('${IMG_URL + item.poster_path}')">
                <div class="rating-badge">${item.vote_average.toFixed(1)}</div>
            </div>
            <div class="card-title">${item.title || item.name}</div>
        `;
        
        // Клік мишкою
        el.onclick = () => openModal(el.dataset);
        container.appendChild(el);
    });
}


// 3. НАВІГАЦІЯ (CONTROLLER)
const Controller = {
    targets: [],
    idx: 0,
    locked: false, // Блокування при відкритій модалці

    scan: function() {
        // Якщо модалка відкрита - фокус тільки там
        if(document.getElementById('modal').classList.contains('active')) {
            this.targets = Array.from(document.querySelectorAll('.modal-btn'));
        } else {
            // Інакше - меню + активний екран
            let screen = document.querySelector('.screen.active');
            let menu = Array.from(document.querySelectorAll('.menu-items .menu-btn'));
            let content = screen ? Array.from(screen.querySelectorAll('.focusable, .card, input')) : [];
            this.targets = [...menu, ...content];
        }
        
        // Якщо фокус злетів
        if(this.idx >= this.targets.length) this.idx = 0;
    },

    focus: function() {
        document.querySelectorAll('.focus').forEach(e => e.classList.remove('focus'));
        if(this.targets[this.idx]) {
            let el = this.targets[this.idx];
            el.classList.add('focus');
            
            el.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
            
            // Якщо це інпут - даємо йому справжній фокус
            if(el.tagName === 'INPUT') el.focus();
            else document.activeElement.blur();
        }
    },

    move: function(dir) {
        this.scan();
        if(this.targets.length === 0) return;

        const cols = 5; // Приблизно колонок
        let prev = this.idx;

        if (dir === 'right') this.idx++;
        if (dir === 'left') this.idx--;
        
        // Проста логіка "Smart Grid"
        if (dir === 'down') {
            // Якщо ми в меню -> йдемо в контент
            if (this.targets[this.idx].classList.contains('menu-btn')) {
                // Шукаємо перший елемент контенту
                let firstContent = this.targets.findIndex(e => !e.classList.contains('menu-btn'));
                if(firstContent !== -1) this.idx = firstContent;
            } else {
                this.idx += cols; // Стрибок вниз
            }
        }
        
        if (dir === 'up') {
            this.idx -= cols;
            if (this.idx < 0) this.idx = 0; // В меню
        }

        // Обмеження
        if (this.idx < 0) this.idx = 0;
        if (this.idx >= this.targets.length) this.idx = this.targets.length - 1;

        this.focus();
    },

    enter: function() {
        let el = this.targets[this.idx];
        if(!el) return;

        if(el.classList.contains('menu-btn')) {
            showScreen(el.dataset.action);
        } else if(el.classList.contains('card')) {
            openModal(el.dataset);
        } else if(el.id === 'do-search') {
            doSearch();
        } else if(el.id === 'btn-watch') {
             // Тут буде запуск плагіна
             alert('Запуск джерела для: ' + document.getElementById('m-title').innerText);
        } else {
            el.click(); // Емуляція кліку
        }
    }
};


// 4. ФУНКЦІЇ ІНТЕРФЕЙСУ
function showScreen(name) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-' + name).classList.add('active');
    
    // Оновлюємо меню
    document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('focus'));
    
    // Спеціальна логіка для екранів
    if(name === 'main' && document.getElementById('main-row').innerHTML === '') {
        loadMain();
    }
    
    // Скидаємо фокус на перший елемент
    setTimeout(() => { Controller.idx = 0; Controller.scan(); Controller.focus(); }, 100);
}

async function loadMain() {
    document.getElementById('main-loader').style.display = 'block';
    let data = await Api.loadTrending();
    document.getElementById('main-loader').style.display = 'none';
    renderCards(data, 'main-row');
}

async function doSearch() {
    let q = document.getElementById('search-input').value;
    if(!q) return;
    
    document.getElementById('search-results').innerHTML = '<div class="loader">Пошук...</div>';
    let data = await Api.search(q);
    renderCards(data, 'search-results');
    
    // Переводимо фокус на результати
    setTimeout(() => { Controller.scan(); Controller.idx = 2; Controller.focus(); }, 500);
}

// Модалка
function openModal(data) {
    document.getElementById('m-title').innerText = data.title;
    document.getElementById('m-poster').style.backgroundImage = `url('${data.img}')`;
    document.getElementById('m-year').innerText = data.year;
    document.getElementById('m-rating').innerText = data.rating;
    document.getElementById('m-descr').innerText = data.overview || 'Опису немає.';
    
    document.getElementById('modal').classList.add('active');
    Controller.scan(); // Тепер фокус в модалці
    Controller.idx = 0; // Кнопка "Дивитись"
    Controller.focus();
}

function closeModal() {
    document.getElementById('modal').classList.remove('active');
    Controller.scan();
    Controller.focus(); // Повертаємо фокус назад
}


// --- START ---
window.onload = () => {
    // Годинник
    setInterval(() => {
        let d = new Date();
        document.getElementById('clock').innerText = d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }, 1000);

    // Слухаємо клавіатуру
    document.addEventListener('keydown', e => {
        if(e.code === 'ArrowRight') Controller.move('right');
        if(e.code === 'ArrowLeft') Controller.move('left');
        if(e.code === 'ArrowDown') Controller.move('down');
        if(e.code === 'ArrowUp') Controller.move('up');
        if(e.code === 'Enter') Controller.enter();
        if(e.code === 'Escape' || e.code === 'Backspace') closeModal();
    });

    // Запускаємо
    showScreen('main');
    console.log('Lampa Zero Loaded');
};
